# 2. 리눅스 시스템 호출, 접근 권한, 능력

---

대부분의 경우 컨테이너는 리눅스 OS 환경에서 실행된다. 따라서, 보안에 영향을 미치는 리눅스의 몇 가지 기본 기능을 익히면 컨테이너 보안에 도움이 된다.

이런 요소들은 컨테이너 안에서 실행되는 리눅스 프로세스들을 호스트가 볼 수 있다는 사실 때문에 중요하다. 컨테이너화된 프로세스도 다른 보통의 프로세스와 마찬가지 방식으로 시스템 호출을 사용하고 접근 권한과 기타 여러 권한을 요구한다.

## 2.1 시스템 호출(System Call)

응용 프로그램은 사용자 공간(User Space)에서 실행된다. 사용자 공간에서 실행되는 코드는 운영체제 커널보다 권한(previlege)이 낮다. 사용자 공간 코드가 커널에 특정 행동을 요청하는 데 쓰이는 프로그래밍 인터페이스를 시스템 호출(System Call)이라고 부른다.

- read : 파일에서 데이터를 읽어 들인다.
- write : 데이터를 파일에 기록한다.
- open : 읽기 또는 쓰기를 위해 파일을 연다.
- execve : 실행 가능 프로그램을 실행한다.
- chown : 파일의 소유자를 변경한다.
- clone : 새 프로세스를 생성한다.

응용 프로그램 코드가 컨테이너 내부에 있든 외부에 있든 시스템 호출을 사용하는 방식 자체는 다름 없다.

하지만, 모든 컨테이너가 하나의 공유 호스트에서 실행된다는 사실 때문에 구체적으로는 모든 컨테이너의 응용 프로그램이 같은 커널에 대해 시스템 호출을 요청한다는 사실 때문에 보안 측면에서 차이가 생긴다.

### 2.2 파일 접근 권한

리눅스 시스템에서 보안의 토대가 되는 것은 파일 접근 권한(file permission)이다. 파일에 대한 접근 권한은 어떤 사용자가 그 파일에 접근 및 행동할 수 있는 권한을 결정한다. 그런 접근 권한은 임의 점근 제어(DAC)라고 지칭한다.

![image](https://github.com/YoungGyo-00/TIL/assets/89639470/2386d8c6-c2e1-46f5-8eee-fd614f6bd58a)

- 처음 세 글자(-rw) : 소유자(liz)의 접근 권한
- 중간 세 글자(r-x) : 파일의 그룹에 속한 사용자들의 접근 권한
- 마지막 세 글자(r—) : 다른 모든 사용자의 접근 권한

### 2.2.1 setuid/setgid

보통 한 사용자가 어떤 파일을 실행하면 해당 프로세스는 그 사용자의 ID로 실행된다. 그러나 파일에 setuid bit를 설정해 두면, 프로세스는 파일 소유자의 ID로 실행된다.

일반적으로 setuid bit는 보통의 사용자에게는 없는 어떤 권한을 프로그램에 부여하는 용도로 사용된다. 전형적인 예는 ping 실행 파일이다. 핑 메시지를 보내려면 네트워크 소켓을 여는 권한이 필요한데, 보통의 사용자에게는 그런 권한이 없다. 보통의 사용자에게도 네트워크 소켓을 여는 권한을 부여하는 것은 올바르지 않은 방법이다.(핑 이외의 다른 용도로 네트워크 소켓을 여는 것을 사용할 수 있으므로)

![image](https://github.com/YoungGyo-00/TIL/assets/89639470/df68117d-5b69-4d30-8a9a-5a7d6bcddc68)

실행 파일 복사본(myping)의 소유자를 root로 변경하더라도 보통의 사용자(vagrant)로 실행하면 여전히 권한이 부족하다. sudo(루트)로 실행해야 실행됨을 확인할 수 있다.

이때 복사본에 setuid를 설정하면 정상적으로 실행되는 것을 아래의 그림을 통해 볼 수 있다.

![image](https://github.com/YoungGyo-00/TIL/assets/89639470/d1a923c4-8af7-43da-8df6-261a00225f4e)

복사본이 setuid 덕분에 루트 계정으로 실행된다고 해도, 리눅스의 동작으로 꼭 필요한 능력들만 설정한 후 사용자 ID를 원래의 사용자의 것으로 재설정하여 실행하기 때문에 프로세스는 루트 계정에서 실행되지 않는다. 최소 권한 원칙에 따라, 프로세스나 파일에 능력을 부여할 때는 작업에 꼭 필요한 능력들만 부여하는 것이 바람직하다.

### 2.3 권한 확대

사용자가 가진 권한을 평소보다 더 넓게 확대해서 보통은 실행하지 못하는 일도 실행하게 만드는 것을 의미한다. 공격자들은 시스템의 취약점이나 잘못된 설정을 이용해서 자신의 권한을 확대함으로써 추가적인 접근 권한을 얻으려고 할 것이다. 종종 공격자는 권한이 없는 보통의 사용자로 시작해서 루트 권한을 얻기 위해 노력할 것이며, 소프트웨어는 이 때문에 가능하면 권한이 없는 보통의 사용자로 실행하는 것을 추천한다.

하지만 기본적으로 컨테이너는 루트 사용자로 실행하게 된다. 전통적인 방법과 달리 컨테이너에서 실행되는 응용 프로그램들은 루트로 실행될 여지가 많다. 만약 컨테이너가 보통의 사용자로 실행된다고 해도, 공격자는 리눅스 접근 권한 관련 매커니즘을 악용해서 권한 확대를 시도할 수 있다.

- 컨테이너 이미지에 `setuid` 가 설정된 실행 파일이 포함되는 경우
- 보통의 사용자로 실행되는 컨테이너에 추가적인 능력들을 배정할 경우
